<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åœ£ç»å•è¯å­¦ä¹ ç»ˆç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap');
        
        body { 
            font-family: 'Shippori Mincho', 'Noto Serif JP', serif; 
            background-color: #f7f3f0; 
            color: #2d2d2d; 
            padding-top: env(safe-area-inset-top);
        }

        /* é€‰é¡¹å¡æ¿€æ´»æ ·å¼ */
        .tab-btn.active {
            background-color: white;
            color: #292524;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .perspective { perspective: 1000px; }
        .card-inner { 
            position: relative; width: 100%; height: 100%; 
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
            transform-style: preserve-3d; cursor: pointer; 
        }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        
        .card-front, .card-back { 
            position: absolute; width: 100%; height: 100%; 
            backface-visibility: hidden; border-radius: 2rem; 
            padding: 2rem; background: white; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
            border: 1px solid #e9e4e1; display: flex; flex-direction: column; 
        }
        .card-back { transform: rotateY(180deg); overflow-y: auto; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .status-offline { background: #ef4444; box-shadow: 0 0 8px #ef4444; }

        /* é€šçŸ¥ */
        .toast-item { animation: slideDown 0.3s ease forwards; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen pb-10">

    <div id="toast-container" class="fixed top-4 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none"></div>

    <div class="max-w-4xl mx-auto px-4">
        <header class="py-6 flex flex-col items-center border-b border-stone-200 mb-6">
            <h1 class="text-2xl font-bold italic text-stone-800 mb-2">åœ£ç»å•è¯è®°å¿†</h1>
            <div class="flex items-center gap-2 mb-6">
                <span id="net-dot" class="status-dot status-online"></span>
                <span id="net-text" class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">åœ¨çº¿åŒæ­¥</span>
            </div>
            
            <!-- ä¿®å¤åçš„é€‰é¡¹å¡ï¼šé€šè¿‡ ID å’Œ class ç¡®ä¿ç‚¹å‡» -->
            <div class="flex bg-stone-200/50 p-1 rounded-2xl w-full max-w-sm z-50">
                <button onclick="changeView('learn')" id="tab-learn" class="tab-btn active flex-1 py-2 rounded-xl text-sm font-bold text-stone-500 transition-all">å­¦ä¹ </button>
                <button onclick="changeView('community')" id="tab-community" class="tab-btn flex-1 py-2 rounded-xl text-sm font-bold text-stone-500 transition-all">åˆ†äº«</button>
                <button onclick="changeView('admin')" id="tab-admin" class="tab-btn flex-1 py-2 rounded-xl text-sm font-bold text-stone-500 transition-all">ç®¡ç†</button>
            </div>
        </header>

        <!-- å­¦ä¹ é¡µé¢ -->
        <section id="view-learn" class="view-content">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-6">
                <input type="date" id="f-date-filter" onchange="applyFilters()" class="h-10 px-3 bg-white border border-stone-200 rounded-xl text-xs">
                <select id="f-book-filter" onchange="applyFilters()" class="h-10 px-3 bg-white border border-stone-200 rounded-xl text-xs">
                    <option value="all">å…¨éƒ¨ä¹¦å·</option>
                </select>
                <select id="f-type-filter" onchange="applyFilters()" class="h-10 px-3 bg-white border border-stone-200 rounded-xl text-xs">
                    <option value="all">å…¨éƒ¨ç±»å‹</option>
                    <option value="å•è¯">å•è¯</option>
                    <option value="è¯­æ³•">è¯­æ³•</option>
                    <option value="æˆè¯­">æˆè¯­</option>
                </select>
                <select id="f-mastery-filter" onchange="applyFilters()" class="h-10 px-3 bg-white border border-stone-200 rounded-xl text-xs font-bold">
                    <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                    <option value="unmastered">ğŸ“– æœªæŒæ¡</option>
                    <option value="mastered">âœ… å·²æŒæ¡</option>
                </select>
            </div>

            <div class="max-w-md mx-auto">
                <div class="flex justify-between items-end mb-2 px-1">
                    <span id="prog-val" class="text-xl font-bold text-stone-800">0 / 0</span>
                    <span id="prog-pct" class="text-[10px] font-bold text-stone-400">0%</span>
                </div>
                <div class="h-1 bg-stone-200 rounded-full overflow-hidden mb-8">
                    <div id="prog-bar" class="h-full bg-stone-800 w-0 transition-all"></div>
                </div>

                <div class="relative h-[400px] perspective mb-8">
                    <div id="card-obj" class="card-inner" onclick="this.classList.toggle('is-flipped')">
                        <div class="card-front justify-center items-center text-center">
                            <span id="c-type" class="absolute top-6 right-6 px-2 py-1 bg-stone-100 text-[10px] font-bold rounded">WORD</span>
                            <div class="absolute top-6 left-6 text-left">
                                <p id="c-date" class="text-[9px] text-stone-300 font-bold">DATE</p>
                                <p id="c-book" class="text-[10px] text-stone-400 italic">BOOK</p>
                            </div>
                            <h2 id="c-word" class="text-4xl font-bold text-stone-800 mb-2">è¿æ¥ä¸­...</h2>
                            <p id="c-reading" class="text-lg text-stone-400 italic">è¯·ç¡®ä¿ç½‘ç»œé€šç•…</p>
                        </div>
                        <div class="card-back">
                            <p id="c-def" class="text-xl font-bold text-stone-800 mb-6 border-l-4 border-stone-800 pl-4"></p>
                            <div class="p-4 bg-stone-50 rounded-2xl border border-stone-100">
                                <p id="c-ex-ja" class="text-stone-700 text-sm mb-2"></p>
                                <p id="c-ex-zh" class="text-stone-400 text-xs italic"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button onclick="mark(false)" class="py-4 bg-white border border-stone-200 rounded-2xl text-stone-400 font-bold text-sm">å†ç»ƒç»ƒ</button>
                    <button onclick="mark(true)" class="py-4 bg-stone-800 text-white rounded-2xl font-bold text-sm shadow-lg">è®°ä½äº†</button>
                </div>
                <div class="flex justify-center gap-12">
                    <button onclick="move(-1)" class="text-stone-300 hover:text-stone-800">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <button onclick="move(1)" class="text-stone-300 hover:text-stone-800">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </section>

        <!-- åˆ†äº«é¡µé¢ -->
        <section id="view-community" class="view-content hidden max-w-2xl mx-auto space-y-4">
            <div class="bg-white p-6 rounded-3xl border border-stone-200 shadow-sm">
                <textarea id="msg-in" placeholder="åˆ†äº«ä»Šæ—¥çš„äº®å…‰..." class="w-full h-24 p-4 bg-stone-50 rounded-2xl text-sm mb-4 resize-none border-none focus:ring-1 focus:ring-stone-200"></textarea>
                <button onclick="postMsg()" class="w-full py-3 bg-stone-800 text-white rounded-xl font-bold">å‘å¸ƒåˆ†äº«</button>
            </div>
            <div id="msg-list" class="space-y-4"></div>
        </section>

        <!-- ç®¡ç†é¡µé¢ -->
        <section id="view-admin" class="view-content hidden max-w-4xl mx-auto">
            <div id="admin-lock" class="text-center py-20 bg-white rounded-3xl border border-stone-200">
                <h3 class="font-bold mb-4">ç®¡ç†å‘˜ç™»å½•</h3>
                <input type="password" id="adm-pass" placeholder="å¯†é’¥: Christ777" class="px-4 py-2 border rounded-xl mb-4 text-center"><br>
                <button onclick="unlockAdmin()" class="px-8 py-2 bg-stone-800 text-white rounded-xl">è§£é”æƒé™</button>
            </div>
            <div id="admin-panel" class="hidden space-y-6">
                <form id="add-word-form" class="bg-white p-6 rounded-3xl border border-stone-200 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="adm-book" class="h-10 border rounded-xl px-3 text-sm"></select>
                    <input type="date" id="adm-date" class="h-10 border rounded-xl px-3 text-sm">
                    <select id="adm-type" class="h-10 border rounded-xl px-3 text-sm">
                        <option value="å•è¯">å•è¯</option><option value="è¯­æ³•">è¯­æ³•</option><option value="æˆè¯­">æˆè¯­</option>
                    </select>
                    <input type="text" id="adm-word" placeholder="å•è¯" class="h-10 border rounded-xl px-3 text-sm">
                    <input type="text" id="adm-reading" placeholder="å‡å" class="h-10 border rounded-xl px-3 text-sm">
                    <input type="text" id="adm-def" placeholder="é‡Šä¹‰" class="h-10 border rounded-xl px-3 text-sm">
                    <textarea id="adm-ex-ja" placeholder="æ—¥è¯­ä¾‹å¥" class="md:col-span-3 h-20 p-3 border rounded-xl text-sm"></textarea>
                    <textarea id="adm-ex-zh" placeholder="ä¸­æ–‡ç¿»è¯‘" class="md:col-span-3 h-20 p-3 border rounded-xl text-sm"></textarea>
                    <button type="submit" class="md:col-span-3 py-3 bg-stone-800 text-white rounded-xl font-bold">å³æ—¶æ¨é€å…¨ç½‘</button>
                </form>
                <div class="bg-white rounded-3xl border border-stone-200 overflow-hidden">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-stone-50 border-b"><tr><th class="p-4">å†…å®¹</th><th class="p-4">æ“ä½œ</th></tr></thead>
                        <tbody id="adm-list" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bible-v6-fixed';

        const bible66 = [
            "å‰µä¸–è¨˜", "å‡ºã‚¨ã‚¸ãƒ—ãƒˆè¨˜", "ãƒ¬ãƒ“è¨˜", "æ°‘æ•°è¨˜", "ç”³å‘½è¨˜", "ãƒ¨ã‚·ãƒ¥ã‚¢è¨˜", "å£«å¸«è¨˜", "ãƒ«ãƒ„è¨˜", "ã‚µãƒ ã‚¨ãƒ«è¨˜ä¸Š", "ã‚µãƒ ã‚¨ãƒ«è¨˜ä¸‹", "åˆ—ç‹è¨˜ä¸Š", "åˆ—ç‹è¨˜ä¸‹", "æ­´ä»£èªŒä¸Š", "æ­´ä»£èªŒä¸‹", "ã‚¨ã‚ºãƒ©è¨˜", "ãƒãƒ˜ãƒŸãƒ¤è¨˜", "ã‚¨ã‚¹ãƒ†ãƒ«è¨˜", "ãƒ¨ãƒ–è¨˜", "è©©ç·¨", "ç®´è¨€", "ä¼é“ã®æ›¸", "é›…æ­Œ", "ã‚¤ã‚¶ãƒ¤æ›¸", "ã‚¨ãƒ¬ãƒŸãƒ¤æ›¸", "å“€æ­Œ", "ã‚¨ã‚¼ã‚­ã‚¨ãƒ«æ›¸", "ãƒ€ãƒ‹ã‚¨ãƒ«æ›¸", "ãƒ›ã‚»ã‚¢æ›¸", "ãƒ¨ã‚¨ãƒ«æ›¸", "ã‚¢ãƒ¢ã‚¹æ›¸", "ã‚ªãƒãƒ‡ãƒ¤æ›¸", "ãƒ¨ãƒŠæ›¸", "ãƒŸã‚«æ›¸", "ãƒŠãƒ›ãƒ æ›¸", "ãƒãƒã‚¯ã‚¯æ›¸", "ã‚¼ãƒ‘ãƒ‹ãƒ¤æ›¸", "ãƒã‚¬ã‚¤æ›¸", "ã‚¼ã‚«ãƒªãƒ¤æ›¸", "ãƒãƒ©ã‚­æ›¸",
            "ãƒã‚¿ã‚¤ã«ã‚ˆã‚‹ç¦éŸ³æ›¸", "ãƒãƒ«ã‚³ã«ã‚ˆã‚‹ç¦éŸ³æ›¸", "ãƒ«ã‚«ã«ã‚ˆã‚‹ç¦éŸ³æ›¸", "ãƒ¨ãƒãƒã«ã‚ˆã‚‹ç¦éŸ³æ›¸", "ä½¿å¾’è¨€è¡ŒéŒ²", "ãƒ­ãƒ¼ãƒã®ä¿¡å¾’ã¸ã®æ‰‹ç´™", "ã‚³ãƒªãƒ³ãƒˆã®ä¿¡å¾’ã¸ã®æ‰‹ç´™ä¸€", "ã‚³ãƒªãƒ³ãƒˆã®ä¿¡å¾’ã¸ã®æ‰‹ç´™äºŒ", "ã‚¬ãƒ©ãƒ†ãƒ¤ã®ä¿¡å¾’ã¸ã®æ‰‹çº¸", "ã‚¨ãƒ•ã‚§ã‚½ã®ä¿¡å¾’ã¸ã®æ‰‹çº¸", "ãƒ•ã‚£ãƒªãƒ”ã®ä¿¡å¾’ã¸ã®æ‰‹çº¸", "ã‚³ãƒ­ã‚µã‚¤ã®ä¿¡å¾’ã¸ã®æ‰‹çº¸", "ãƒ†ã‚µãƒ­ãƒ‹ã‚±ã®ä¿¡å¾’ã¸ã®æ‰‹çº¸ä¸€", "ãƒ†ã‚µãƒ­ãƒ‹ã‚±ã®ä¿¡å¾’ã¸ã®æ‰‹çº¸äºŒ", "ãƒ†ãƒ¢ãƒ†ã¸ã®æ‰‹çº¸ä¸€", "ãƒ†ãƒ¢ãƒ†ã¸ã®æ‰‹çº¸äºŒ", "ãƒ†ãƒˆã‚¹ã¸ã®æ‰‹çº¸", "ãƒ•ã‚£ãƒ¬ãƒ¢ãƒ³ã¸ã®æ‰‹çº¸", "ãƒ˜ãƒ–ãƒ©ã‚¤äººã¸ã®æ‰‹çº¸", "ãƒ¤ã‚³ãƒ–ã®æ‰‹çº¸", "ãƒšãƒˆãƒ­ã®æ‰‹çº¸ä¸€", "ãƒšãƒˆãƒ­ã®æ‰‹çº¸äºŒ", "ãƒ¨ãƒãƒã®æ‰‹çº¸ä¸€", "ãƒ¨ãƒãƒã®æ‰‹çº¸äºŒ", "ãƒ¨ãƒãƒã®æ‰‹çº¸ä¸‰", "ãƒ¦ãƒ€ã®æ‰‹çº¸", "ãƒ¨ãƒãƒã®é»™ç¤ºéŒ²"
        ];

        let words = [], filtered = [], index = 0, user = null, isAdmin = false;

        // --- æ ¸å¿ƒä¿®å¤ï¼šæ›´å¼ºçš„ Tab åˆ‡æ¢ ---
        window.changeView = (target) => {
            // éšè—æ‰€æœ‰è§†å›¾
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            // æ˜¾ç¤ºç›®æ ‡è§†å›¾
            document.getElementById(`view-${target}`).classList.remove('hidden');
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${target}`).classList.add('active');
        };

        window.unlockAdmin = () => {
            if(document.getElementById('adm-pass').value === "Christ777") {
                isAdmin = true;
                document.getElementById('admin-lock').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                renderAdmin();
            } else { alert("å¯†é’¥é”™è¯¯"); }
        };

        window.applyFilters = () => {
            const date = document.getElementById('f-date-filter').value;
            const book = document.getElementById('f-book-filter').value;
            const type = document.getElementById('f-type-filter').value;
            const mastery = document.getElementById('f-mastery-filter').value;

            filtered = words.filter(w => {
                const isM = w.mastered_by?.includes(user?.uid);
                const matchM = mastery === 'unmastered' ? !isM : (mastery === 'mastered' ? isM : true);
                return (!date || w.date === date) && (book === 'all' || w.book === book) && (type === 'all' || w.category === type) && matchM;
            });
            index = 0; render();
        };

        window.move = (step) => {
            if(filtered.length <= 1) return;
            index = (index + step + filtered.length) % filtered.length;
            document.getElementById('card-obj').classList.remove('is-flipped');
            render();
        };

        window.mark = async (status) => {
            if(!filtered[index]) return;
            const w = filtered[index];
            let list = w.mastered_by || [];
            if(status) { if(!list.includes(user.uid)) list.push(user.uid); }
            else { list = list.filter(id => id !== user.uid); }
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vocabulary', w.id), { mastered_by: list });
            move(1);
        };

        window.postMsg = async () => {
            const text = document.getElementById('msg-in').value.trim();
            if(!text) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), { text, createdAt: Date.now() });
            document.getElementById('msg-in').value = "";
            showToast("åŒæ­¥æˆåŠŸ", "æ„Ÿè°¢æ‚¨çš„åˆ†äº«");
        };

        window.delWord = async (id) => {
            if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'vocabulary', id));
        };

        function showToast(title, msg) {
            const container = document.getElementById('toast-container');
            const item = document.createElement('div');
            item.className = "toast-item bg-white shadow-xl border p-4 rounded-2xl w-64 pointer-events-auto";
            item.innerHTML = `<p class="text-[9px] font-bold text-stone-400 uppercase">${title}</p><p class="text-xs font-bold text-stone-800">${msg}</p>`;
            container.appendChild(item);
            setTimeout(() => { item.style.opacity = '0'; setTimeout(() => item.remove(), 500); }, 3000);
        }

        function render() {
            const total = filtered.length, mCount = filtered.filter(w => w.mastered_by?.includes(user?.uid)).length;
            const pct = total > 0 ? (mCount/total)*100 : 0;
            document.getElementById('prog-val').innerText = `${mCount} / ${total}`;
            document.getElementById('prog-pct').innerText = `${Math.round(pct)}%`;
            document.getElementById('prog-bar').style.width = `${pct}%`;

            if(total === 0) {
                document.getElementById('c-word').innerText = "æ— è¯æ¡";
                document.getElementById('c-reading').innerText = "è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶";
                return;
            }
            const w = filtered[index];
            document.getElementById('c-word').innerText = w.word;
            document.getElementById('c-reading').innerText = w.reading;
            document.getElementById('c-date').innerText = w.date || "----/--/--";
            document.getElementById('c-book').innerText = w.book;
            document.getElementById('c-type').innerText = w.category;
            document.getElementById('c-def').innerText = w.definition;
            document.getElementById('c-ex-ja').innerText = w.example_ja;
            document.getElementById('c-ex-zh').innerText = w.example_zh;
        }

        function renderAdmin() {
            document.getElementById('adm-list').innerHTML = words.sort((a,b)=>b.createdAt-a.createdAt).map(w => `
                <tr><td class="p-4"><b>${w.word}</b></td><td class="p-4 text-right"><button onclick="delWord('${w.id}')" class="text-red-300">åˆ é™¤</button></td></tr>
            `).join('');
        }

        const start = async () => {
            const bFilter = document.getElementById('f-book-filter');
            const bAdm = document.getElementById('adm-book');
            bible66.forEach(b => {
                const op = `<option value="${b}">${b}</option>`;
                bFilter.innerHTML += op;
                if(bAdm) bAdm.innerHTML += op;
            });
            document.getElementById('adm-date').valueAsDate = new Date();

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
            
            onAuthStateChanged(auth, u => {
                user = u;
                if(u) {
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'vocabulary'), snap => {
                        words = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        applyFilters();
                        if(isAdmin) renderAdmin();
                    });
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), snap => {
                        const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>b.createdAt - a.createdAt);
                        document.getElementById('msg-list').innerHTML = msgs.map(m => `
                            <div class="bg-white p-5 rounded-2xl border border-stone-100">
                                <p class="text-sm text-stone-700">${m.text}</p>
                            </div>
                        `).join('');
                    });
                }
            });
        };

        document.getElementById('add-word-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                book: document.getElementById('adm-book').value,
                date: document.getElementById('adm-date').value,
                category: document.getElementById('adm-type').value,
                word: document.getElementById('adm-word').value,
                reading: document.getElementById('adm-reading').value,
                definition: document.getElementById('adm-def').value,
                example_ja: document.getElementById('adm-ex-ja').value,
                example_zh: document.getElementById('adm-ex-zh').value,
                mastered_by: [], createdAt: Date.now()
            };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'vocabulary'), data);
            e.target.reset();
            document.getElementById('adm-date').valueAsDate = new Date();
            showToast("åŒæ­¥æˆåŠŸ", "å†…å®¹å·²æ¨é€åˆ°å…¨ç½‘");
        };

        start();
    </script>
</body>
</html>

